###
# binary_sensor/motion/shelly.yaml
###

- platform: template
  sensors:
    motion_detector_shelly_announce:
      value_template: >-
        {% set s = states('input_boolean.motion_detector_shelly_announce') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {{- s -}}
        {% else %}true{% endif %}
    motion_detector_shelly:
      friendly_name: Shelly motion
      device_class: 'occupancy'
      availability_template: >-
        {{ state_attr('sensor.motion_detector_shelly_status','active')|lower == 'true' }}
      icon_template: >-
        {% if state_attr('sensor.motion_detector_shelly_status','motion')|lower == 'true' %}
          {{- 'mdi:motion-sensor' -}}
        {% else %}
          {{- 'mdi:motion-sensor-off' -}}
        {% endif %}
      attribute_templates:
        vibration: >-
          {{ state_attr('sensor.motion_detector_shelly_status','vibration')|lower == 'true' }}
        active: >-
          {{ state_attr('sensor.motion_detector_shelly_status','active')|lower == 'true' }}
        lux: >-
          {{ state_attr('sensor.motion_detector_shelly_status','lux') }}
        bat: >- 
          {{ state_attr('sensor.motion_detector_shelly_status','bat') }}
        timestamp: >-
          {{ state_attr('sensor.motion_detector_shelly_status','timestamp') }}
        end: >-
          {% if states('sensor.motion_detector_shelly_start')|lower != 'null' %}
            {% if state_attr('sensor.motion_detector_shelly_status','motion')|lower == 'false' %}
              {{ state_attr('sensor.motion_detector_shelly_status','timestamp') }}
            {% else %}null{% endif %}
          {% else %}
            {{ states('sensor.motion_detector_shelly_end') }}
          {% endif %}
        start: >-
          {% if states('sensor.motion_detector_shelly_start')|lower == 'null' %}
            {% if state_attr('sensor.motion_detector_shelly_status','motion')|lower == 'true' %}
              {{ state_attr('sensor.motion_detector_shelly_status','timestamp') }}
            {% else %}null{% endif %}
          {% else %}
            {{ states('sensor.motion_detector_shelly_start') }}
          {% endif %}
        when: >-
          {% set s = state_attr('binary_sensor.motion_detector_shelly','start') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {{ s|int|timestamp_custom("%a %b %d %I:%M:%S %p %Z") -}}
          {% else %}Pending{% endif %}
        duration: >-
          {{ states('sensor.motion_detector_shelly_duration') }}
        last: >-
          {{ states('sensor.motion_detector_shelly_last') }}
        ago: >-
          {% set s = state_attr('binary_sensor.motion_detector_shelly','last') %}
          {% if s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'none' and s|lower != 'null' and s|int > 0 %}
            {{ utcnow().timestamp()|int - s|int }}
          {% else %}null{% endif %}
      value_template: >-
        {% set s = state_attr('sensor.motion_detector_shelly_status','motion') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {{ s|lower == 'true' }}
        {% else %}false{% endif %}
