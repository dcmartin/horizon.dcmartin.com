###
# homeassistant/automation/motion/shelly.yaml
###

- id: motion_shellies_occupancy_counter
  alias: motion_shellies_occupancy_counter
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_shellies_occupancy
    to: 'on'
    from: 'off'
  action:
    - service: counter.increment
      entity_id: counter.motion_shellies_occupancy

- id: motion_shellies_mqtt_status
  alias: motion_shellies_mqtt_status
  initial_state: on
  mode: queued
  trigger:
    - platform: mqtt
      topic: 'shellies/+/light/0/status'
    - platform: mqtt
      topic: 'shellies/+/status'
  variables:
    topic: >-
      {{ trigger.topic }}
    status: >-
      {{ trigger.payload_json }}
    id: >-
      {{ topic|replace('shellies/','')|replace('/light/0','')|replace('/status','') }}
    timestamp: >-
      {% if trigger.payload_json['timestamp'] %}
        {% set s =  trigger.payload_json.timestamp %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|int > 0 %}
          {{ s }}
        {% else %}
          {{ utcnow().timestamp()|int }}
        {% endif %}
      {% else %}
        {{ utcnow().timestamp()|int }}
      {% endif %}
    mac: >-
      {% if id|lower != 'none' and id|lower != 'unavailable' and id|lower != 'unknown' and id|lower != 'null' and id|length > 0 %}
        {% set s = states('group.motion_shellies') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {% set s = state_attr('group.motion_shellies','entity_id') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% for i in s if state_attr(i,'id') == id %}
              {% if loop.first %}{{ state_attr(i,'mac') }}{% endif %}
            {% endfor %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    type: >-
      {% if mac|lower != 'none' and mac|lower != 'unavailable' and mac|lower != 'unknown' and mac|lower != 'null' and mac|length > 0 %}
        {% set s = states('group.motion_shellies') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {% set s = state_attr('group.motion_shellies','entity_id') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% for i in s if state_attr(i,'mac') == mac %}
              {% if loop.first %}{{ state_attr(i,'type') }}{% endif %}
            {% endfor %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    sensor: >-
      {% if mac|lower != 'none' and mac|lower != 'unavailable' and mac|lower != 'unknown' and mac|lower != 'null'
        and type|lower != 'none' and type|lower != 'unavailable' and type|lower != 'unknown' and type|lower != 'null' %}
        {{ 'binary_sensor.motion_shelly_' + type|string + '_' + mac|string }}
      {% else %}null{% endif %}
    model: >-
      {% if sensor|lower != 'none' and sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' %}
        {{ state_attr(sensor,'model') }}
      {% else %}null{% endif %}
    latitude: >-
      {% if sensor|lower != 'none' and sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' %}
        {% set s = state_attr(sensor,'settings') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {{ s.lat }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    longitude: >-
      {% if sensor|lower != 'none' and sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' %}
        {% set s = state_attr(sensor,'settings') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {{ s.lng }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    state: >-
      {% if trigger.payload_json['motion'] %}
        {% if trigger.payload_json.motion|lower == 'true' %}on{% else %}off{% endif %}
      {% elif trigger.payload_json['ison'] %}
        {% if trigger.payload_json.ison|lower == 'true' %}on{% else %}off{% endif %}
      {% else %}unknown{% endif %}
  action:
    - alias: 'test status is not null'
      condition: and
      conditions:
        - condition: template
          value_template: >-
            {{ status|lower != 'unavailable' and status|lower != 'unknown' and status|lower != 'null' and status|lower != 'none' }}
    - alias: 'test mac is not null'
      condition: and
      conditions:
        - condition: template
          value_template: >-
            {{ mac|lower != 'unavailable' and mac|lower != 'unknown' and mac|lower != 'null' and mac|lower != 'none' and mac|length > 0 }}
    - alias: 'test type is not null'
      condition: and
      conditions:
        - condition: template
          value_template: >-
            {{ type|lower != 'unavailable' and type|lower != 'unknown' and type|lower != 'null' and type|lower != 'none' and type|length > 0 }}
    - alias: 'set binary_sensor.motion_shelly_<type>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{ 'binary_sensor.motion_shellies_' + type|string }}
        id: >-
          {{ id }}
        model: >-
          {{ model }}
        type: >-
          {{ type }}
        mac: >-
          {{ mac }}
        timestamp: >-
          {{ timestamp }}
        status: >-
          {{ status }}
        state: >-
          {{ state }}
    - alias: 'set binary_sensor.motion_shelly_<type>_<mac>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{ sensor }}
        status: >-
          {{ status }}
        timestamp: >-
          {{ timestamp }}
        state: >-
          {{ state }}
    - alias: 'test if sensor on'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ state == 'on' }}
    - alias: 'set last: binary_sensor.motion_shelly_<type>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{ 'binary_sensor.motion_shellies_' + type|string }}
        last: >-
          {{ timestamp }}
        state: >-
          {{ state }}
    - alias: 'set last: binary_sensor.motion_shelly_<type>_<mac>'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{ 'binary_sensor.motion_shelly_' + type|string + '_' + mac|string }}
        last: >-
          {{ timestamp }}
        state: >-
          {{ state }}
    - alias: 'test gps is not null'
      condition: and
      conditions:
        - condition: template
          value_template: >-
            {{ latitude|lower != 'null' and longitude|lower != 'null' }}
    - alias: 'set location: sensor.motion_shellies_<type>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{ 'sensor.motion_shellies_' + type|string }}
        timestamp: >-
          {{ timestamp }}
        latitude: >-
          {{ latitude }}
        longitude: >-
          {{ longitude }}
        status: >-
          {{ status }}
        state: >-
          {{ id }}

# update on motion start

- id: motion_shellies_occupancy_start
  alias: motion_shellies_occupancy_start
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_shellies_occupancy
    from: 'off'
    to: 'on'
  variables:
    sensor: >-
      {% set mac = state_attr('binary_sensor.motion_shellies_occupancy','mac') %}
      {% if mac|lower != 'none' and mac|lower != 'unavailable' and mac|lower != 'unknown' and mac|lower != 'null' and mac|length > 0 %}
        {% set s = states('binary_sensor.motion_shellies_occupancy_' + mac) %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ 'binary_sensor.motion_shellies_occupancy_' + mac|string }}
        {% else %}null{% endif %}
      {% else %}
        {% set s = states('group.motion_shellies') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {% set s = state_attr('group.motion_shellies','entity_id') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|count == 1 %}
            {{ s|first }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% endif %}
    type: >-
      {% if sensor|lower != 'none' and sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' %}
        {% set s = state_attr(sensor,'type') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {{ s }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    timestamp: >-
      {% set s = states(sensor) %}
      {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
        {% set s = state_attr(sensor,'timestamp') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|int > 0 %}
          {{ s }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    when: >-
      {% if timestamp|lower != 'none' and timestamp|lower != 'unavailable' and timestamp|lower != 'unknown' and timestamp|lower != 'null' %}
        {{ timestamp|int|timestamp_custom("%a %b %d %I:%M:%S %p %Z") }}
      {% else %}Pending{% endif %}
  action:
    - alias: 'set on: binary_sensor.motion_shellies_occupancy'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{- 'binary_sensor.motion_shellies_occupancy' -}}
        timestamp: >-
          {{ timestamp }}
        last: >-
          {{ timestamp }}
        when: >-
          {{ when }}
        start: >-
          {{ timestamp }}
        end: >-
          {{- 'null' -}}
        state: >-
          {{- 'on' -}}
    - alias: 'test sensor is not null'
      condition: and
      conditions:
        - condition: template
          value_template: >-
            {{ sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' and sensor|lower != 'none' }}
    - alias: 'set on: binary_sensor.motion_shellies_occupancy_<mac>'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{ sensor }}
        when: >-
          {{ when }}
        timestamp: >-
          {{ timestamp }}
        last: >-
          {{ timestamp }}
        start: >-
          {{ timestamp }}
        end: >-
          {{- 'null' -}}
        state: >-
          {{- 'on' -}}

- id: motion_shellies_occupancy_end
  alias: motion_shellies_occupancy_end
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.motion_shellies_occupancy
    from: 'on'
    from: 'off'
  variables:
    sensor: >-
      {% set mac = state_attr('binary_sensor.motion_shellies_occupancy','mac') %}
      {% if mac|lower != 'none' and mac|lower != 'unavailable' and mac|lower != 'unknown' and mac|lower != 'null' and mac|length > 0 %}
        {% set s = states('binary_sensor.motion_shellies_occupancy_' + mac) %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' %}
          {{ 'binary_sensor.motion_shellies_occupancy_' + mac|string }}
        {% else %}null{% endif %}
      {% else %}
        {% set s = states('group.motion_shellies') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {% set s = state_attr('group.motion_shellies','entity_id') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|count == 1 %}
            {{ s|first }}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% endif %}
    type: >-
      {% if sensor|lower != 'none' and sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' %}
        {% set s = state_attr(sensor,'type') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {{ s }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    timestamp: >-
      {% if sensor|lower != 'none' and sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' %}
        {% set s = state_attr(sensor,'timestamp') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|int > 0 %}
          {{ s }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    when: >-
      {% if timestamp|lower != 'none' and timestamp|lower != 'unavailable' and timestamp|lower != 'unknown' and timestamp|lower != 'null' %}
        {{ timestamp|int|timestamp_custom("%a %b %d %I:%M:%S %p %Z") }}
      {% else %}Pending{% endif %}
    duration: >-
      {% set s = state_attr(sensor,'start') %}
      {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' and s|int > 0 and timestamp|int > 0 %}
        {{ timestamp|int - s|int }}
      {% else %}null{% endif %}
  action:
    - alias: 'set off: binary_sensor.motion_shellies_occupancy'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{- 'binary_sensor.motion_shellies_occupancy' -}}
        timestamp: >-
          {{ timestamp }}
        last: >-
          {{ timestamp }}
        end: >-
          {{ timestamp }}
        duration: >-
          {{ duration }}
        when: >-
          {{ when }}
        state: >-
          {{- 'off' -}}
    - alias: 'test sensor is not null'
      condition: and
      conditions:
        - condition: template
          value_template: >-
            {{ sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' and sensor|lower != 'none' }}
    - alias: 'set off: binary_sensor.motion_shellies_occupancy_<mac>'
      service: python_script.set_state
      data_template:
        entity_id: >-
          {{- sensor -}}
        timestamp: >-
          {{ timestamp }}
        last: >-
          {{ timestamp }}
        end: >-
          {{ timestamp }}
        duration: >-
          {{ duration }}
        when: >-
          {{ when }}
        state: >-
          {{- 'off' -}}

- id: motion_shellies_mqtt_announce_publish
  alias: motion_shellies_mqtt_announce_publish
  initial_state: on
  trigger:
    - platform: time_pattern
      minutes: /15
    - platform: event
      event_type: homeassistant_start
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_shellies_publish','on') }}
  action:
    - alias: 'publish command'
      service_template: mqtt.publish
      data_template:
        topic: >-
          {{- 'shellies/command' -}}
        payload_template: >-
          {{- 'announce' -}}
        qos: 2
        retain: false

# handle updates from REST API call to get settings from IP set on binary_sensor.motion_shellies_occupancy

- id: motion_shellies_settings
  alias: motion_shellies_settings
  initial_state: on
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.motion_shellies_settings
  variables:
    settings: >-
      {% set s = states('sensor.motion_shellies_settings') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ states.sensor.motion_shellies_settings.attributes }}
      {% else %}null{% endif %}
    latitude: >-
      {% set s = states('sensor.motion_shellies_settings') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ state_attr('sensor.motion_shellies_settings','lat')|float }}
      {% else %}null{% endif %}
    longitude: >-
      {% set s = states('sensor.motion_shellies_settings') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ state_attr('sensor.motion_shellies_settings','lng')|float }}
      {% else %}null{% endif %}
    mac: >-
      {% set s = states('sensor.motion_shellies_settings') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_shellies_settings','device') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ s.mac }}
        {% else %}{{- 'unknown' -}}{% endif %}
      {% else %}{{- 'unknown' -}}{% endif %}
    type: >-
      {% if mac|lower != 'none' and mac|lower != 'unavailable' and mac|lower != 'unknown' and mac|lower != 'null' and mac|length > 0 %}
        {% set s = states('group.motion_shellies') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {% set s = state_attr('group.motion_shellies','entity_id') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% for i in s if state_attr(i,'mac') == mac %}
              {% if loop.first %}{{ state_attr(i,'type') }}{% endif %}
            {% endfor %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    sensor: >-
      {% if mac|lower != 'none' and mac|lower != 'unavailable' and mac|lower != 'unknown' and mac|lower != 'null'
        and type|lower != 'none' and type|lower != 'unavailable' and type|lower != 'unknown' and type|lower != 'null' and type|length > 0 %}
        {{ 'binary_sensor.motion_shelly_' + type|string + '_' + mac|string }}
      {% else %}null{% endif %}
    id: >-
      {% if sensor|lower != 'none' and sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' %}
        {{ state_attr(sensor,'id') }}
      {% else %}null{% endif %}
    state: >-
      {% if sensor|lower != 'none' and sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' %}
        {% if is_state(sensor,'on') -%}on{% else %}off{% endif %}
      {% else %}null{% endif %}
    updated: >-
      {% set s = states('sensor.motion_shellies_settings') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ states.sensor.motion_shellies_settings.last_updated|as_timestamp|int }}
      {% else %}null{% endif %}
  action:
    - alias: 'test if sensor is defined'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ sensor|lower != 'null' }}
    - alias: 'update binary_sensor.motion_shelly_<type>_<mac>'
      service: python_script.set_state
      data_template:
        allow_create: true
        friendly_name: >-
          {{ type|capitalize + ' in ' + id }}
        entity_id: >-
          {{ sensor }}
        latitude: >-
          {{ latitude }}
        longitude: >-
          {{ longitude }}
        settings: >-
          {{ settings }}
        state: >-
          {{ state }}

## update on REST sensor '<username>:<password>@<ip>/shellies/<id>/status'

- id: motion_shellies_update
  alias: motion_shellies_update
  initial_state: off
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.motion_shellies_update
  variables:
    info: >-
      {% set s = states('sensor.motion_shellies_update') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {{ states.sensor.motion_shellies_update.attributes }}
      {% else %}null{% endif %}
    mac: >-
      {% set s = states('sensor.motion_shellies_update') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_shellies_update','mac') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
          {{ s }}
        {% else %}{{- 'unknown' -}}{% endif %}
      {% else %}{{- 'unknown' -}}{% endif %}
    type: >-
      {% if mac|lower != 'none' and mac|lower != 'unavailable' and mac|lower != 'unknown' and mac|lower != 'null' and mac|length > 0 %}
        {% set s = states('group.motion_shellies') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {% set s = state_attr('group.motion_shellies','entity_id') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% for i in s if state_attr(i,'mac') == mac %}
              {% if loop.first %}{{ state_attr(i,'type') }}{% endif %}
            {% endfor %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    sensor: >-
      {% if mac|lower != 'none' and mac|lower != 'unavailable' and mac|lower != 'unknown' and mac|lower != 'null'
        and type|lower != 'none' and type|lower != 'unavailable' and type|lower != 'unknown' and type|lower != 'null' and type|length > 0 %}
        {{ 'binary_sensor.motion_shelly_' + type|string + '_' + mac|string }}
      {% else %}null{% endif %}
    id: >-
      {% if sensor|lower != 'none' and sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' %}
        {{ state_attr(sensor,'id') }}
      {% else %}null{% endif %}
    state: >-
      {% if sensor|lower != 'none' and sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' %}
        {% if is_state(sensor,'on') -%}on{% else %}off{% endif %}
      {% else %}null{% endif %}
    updated: >-
      {% set s = states('sensor.motion_shellies_update') %}
      {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {% set s = state_attr('sensor.motion_shellies_update','unixtime') %}
        {%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' and s|int > 0 -%}
          {{ s }}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
  action:
    - alias: 'test if sensor is defined'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ sensor|lower != 'null' }}
    - alias: 'update binary_sensor.motion_shelly_<type>_<mac>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{ sensor }}
        info: >-
          {{ info }}
        updated: >-
          {{ updated }}
        state: >-
          {{ state }}

##
## update on MQTT payload 'shellies/+/info'
##

# motion

# {
#   "bat": {
#     "value": 100,
#     "voltage": 4.171
#   },
#   "cfg_changed_cnt": 0,
#   "charger": true,
#   "cloud": {
#     "connected": false,
#     "enabled": false
#   },
#   "has_update": false,
#   "lux": {
#     "illumination": "bright",
#     "is_valid": true,
#     "value": 1027
#   },
#   "mac": "60A423D3F280",
#   "mqtt": {
#     "connected": true,
#     "enabled": true
#   },
#   "sensor": {
#     "active": true,
#     "is_valid": true,
#     "motion": false,
#     "timestamp": 1622451089,
#     "vibration": false
#   },
#   "serial": 212,
#   "time": "09:09",
#   "timestamp": -1815024272,
#   "unixtime": 1622452158,
#   "update": {
#     "beta_version": "",
#     "has_update": false,
#     "new_version": "20210226-072307/v1.1.0@f31e1d2b",
#     "old_version": "20210226-072307/v1.1.0@f31e1d2b",
#     "status": "idle"
#   },
#   "uptime": 75681,
#   "wifi_sta": {
#     "connected": true,
#     "ip": "192.168.1.210",
#     "rssi": -48,
#     "ssid": "CABIN"
#   }
# }

# bulb

# {
#   "actions_stats": {
#     "skipped": 0
#   },
#   "cfg_changed_cnt": 0,
#   "cloud": {
#     "connected": false,
#     "enabled": false
#   },
#   "fs_free": 163903,
#   "fs_size": 233681,
#   "has_update": false,
#   "lights": [
#     {
#       "brightness": 50,
#       "has_timer": false,
#       "ison": true,
#       "source": "http",
#       "timer_duration": 0,
#       "timer_remaining": 0,
#       "timer_started": 0
#     }
#   ],
#   "mac": "ECFABC6F7138",
#   "meters": [
#     {
#       "counters": [
#         1.5,
#         1.5,
#         1.5
#       ],
#       "is_valid": true,
#       "power": 1.5,
#       "timestamp": 1623443734,
#       "total": 199
#     }
#   ],
#   "mqtt": {
#     "connected": true
#   },
#   "ping_check": true,
#   "ram_free": 39576,
#   "ram_total": 50880,
#   "serial": 1,
#   "time": "20:35",
#   "unixtime": 1623443734,
#   "update": {
#     "has_update": false,
#     "new_version": "20210429-100039/v1.10.4-g3f94cd7",
#     "old_version": "20210429-100039/v1.10.4-g3f94cd7",
#     "status": "idle"
#   },
#   "uptime": 8538,
#   "wifi_sta": {
#     "connected": true,
#     "ip": "192.168.1.217",
#     "rssi": -52,
#     "ssid": "CABIN"
#   }
# }

# shellies_info

- id: motion_shellies_info
  alias: motion_shellies_info
  initial_state: on
  mode: queued
  trigger:
    - platform: mqtt
      topic: 'shellies/+/info'
  variables:
    topic: >-
      {{ trigger.topic }}
    id: >-
      {{ topic|replace('shellies/','')|replace('/info','') }}
    ip: >-
      {{ trigger.payload_json.ip }}
    mac: >-
      {{ trigger.payload_json.mac }}
    model: >-
      {{ trigger.payload_json.model }}
    updated: >-
      {{ trigger.payload_json.unixtime }}
    info: >-
      {{ trigger.payload_json }}
    type: >-
      {% if mac|lower != 'none' and mac|lower != 'unavailable' and mac|lower != 'unknown' and mac|lower != 'null' and mac|length > 0 %}
        {% set s = states('group.motion_shellies') %}
        {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
          {% set s = state_attr('group.motion_shellies','entity_id') %}
          {% if s|lower != 'none' and s|lower != 'unavailable' and s|lower != 'unknown' and s|lower != 'null' %}
            {% for i in s if state_attr(i,'mac') == mac %}
              {% if loop.first %}{{ state_attr(i,'type') }}{% endif %}
            {% endfor %}
          {% else %}null{% endif %}
        {% else %}null{% endif %}
      {% else %}null{% endif %}
    sensor: >-
      {% if mac|lower != 'none' and mac|lower != 'unavailable' and mac|lower != 'unknown' and mac|lower != 'null'
        and type|lower != 'none' and type|lower != 'unavailable' and type|lower != 'unknown' and type|lower != 'null' and type|length > 0 %}
        {{ 'binary_sensor.motion_shelly_' + type|string + '_' + mac|string }}
      {% else %}null{% endif %}
    state: >-
      {% if sensor|lower != 'none' and sensor|lower != 'unavailable' and sensor|lower != 'unknown' and sensor|lower != 'null' %}
        {% if is_state(sensor,'on') -%}on{% else %}off{% endif %}
      {% else %}null{% endif %}
  action:
    - alias: 'test if sensor is defined'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ sensor|lower != 'null' }}
    - alias: 'update binary_sensor.motion_shelly_<type>_<mac>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{ sensor }}
        info: >-
          {{ info }}
        updated: >-
          {{ updated }}
        state: >-
          {{ state }}

##
## update on MQTT payload 'shellies/+/announce'
##

# type: motion

# {
#   "fw_ver": "20210226-072307/v1.1.0@f31e1d2b",
#   "id": "shellymotionsensor-60A423D3F280",
#   "ip": "192.168.1.210",
#   "mac": "60A423D3F280",
#   "model": "SHMOS-01",
#   "new_fw": false
# }

# type: light

# {
#   "fw_ver": "20210429-100039/v1.10.4-g3f94cd7",
#   "id": "bulb-sconce-left",
#   "ip": "192.168.1.217",
#   "mac": "ECFABC6F7138",
#   "model": "SHVIN-1",
#   "new_fw": false
# }
#
# {
#   "fw_ver": "20210429-100125/v1.10.4-g3f94cd7",
#   "id": "light-nightstand-david",
#   "ip": "192.168.1.215",
#   "mac": "BCDDC26641D3",
#   "model": "SHBDUO-1",
#   "new_fw": false
# }

- id: motion_shellies_mqtt_announce
  alias: motion_shellies_mqtt_announce
  initial_state: on
  mode: queued
  trigger:
    - platform: mqtt
      topic: 'shellies/+/announce'
  variables:
    topic: >-
      {{ trigger.topic }}
    id: >-
      {{ topic|replace('shellies/','')|replace('/announce','') }}
    ip: >-
      {{ trigger.payload_json.ip }}
    mac: >-
      {{ trigger.payload_json.mac }}
    model: >-
      {{ trigger.payload_json.model }}
    announce: >-
      {{ trigger.payload_json }}
    type: >-
      {% if model == 'SHMOS-01' %}
        {{ 'occupancy' }}
      {% elif model == 'SHBDUO-1' or model == 'SHVIN-1' %}
        {{ 'light' }}
      {% else %}null{% endif %}
    ids: >-
      {% set s = states('group.motion_shellies') %}
      [{%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {%- set prior = state_attr('group.motion_shellies','ids') -%}
        {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
          {% set prior = prior|string|from_json %}
          {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
            {% if prior is iterable %}
              {% if prior|length > 0 -%}
                {%- for p in prior if p|length > 0 -%}
                  {%- if loop.first -%}{%- else -%},{% endif -%}
                  "{{- p -}}"
                {%- endfor -%}
              {%- else -%}{%- set prior = null -%}{%- endif -%}
            {%- else -%}{%- set prior = null -%}{%- endif -%}
          {%- else -%}{%- set prior = null -%}{%- endif -%}
        {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- if prior != null -%},{%- endif -%}
      "{{- id -}}"]
    models: >-
      {% set s = states('group.motion_shellies') %}
      [{%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {%- set prior = state_attr('group.motion_shellies','models') -%}
        {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
          {% set prior = prior|string|from_json %}
          {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
            {% if prior is iterable %}
              {% if prior|length > 0 -%}
                {%- for p in prior if p|length > 0 -%}
                  {%- if loop.first -%}{%- else -%},{% endif -%}
                  "{{- p -}}"
                {%- endfor -%}
              {%- else -%}{%- set prior = null -%}{%- endif -%}
            {%- else -%}{%- set prior = null -%}{%- endif -%}
          {%- else -%}{%- set prior = null -%}{%- endif -%}
        {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- if prior != null -%},{%- endif -%}
      "{{- model -}}"]
    macs: >-
      {% set s = states('group.motion_shellies') %}
      [{%- if s|lower != 'none' and s|lower != 'unknown' and s|lower != 'unavailable' and s|lower != 'null' -%}
        {%- set prior = state_attr('group.motion_shellies','macs') -%}
        {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
          {% set prior = prior|string|from_json %}
          {%- if prior|lower != 'none' and prior|lower != 'unknown' and prior|lower != 'unavailable' and prior|lower != 'null' %}
            {% if prior is iterable %}
              {% if prior|length > 0 -%}
                {%- for p in prior if p|length > 0 -%}
                  {%- if loop.first -%}{%- else -%},{% endif -%}
                  "{{- p -}}"
                {%- endfor -%}
              {%- else -%}{%- set prior = null -%}{%- endif -%}
            {%- else -%}{%- set prior = null -%}{%- endif -%}
          {%- else -%}{%- set prior = null -%}{%- endif -%}
        {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- else -%}{%- set prior = null -%}{%- endif -%}
      {%- if prior != null -%},{%- endif -%}
      "{{- mac -}}"]
    updated: >-
      {{ utcnow().timestamp()|int }}
    sensor: >-
      {{- 'binary_sensor.motion_shelly_' + type|string + '_' + mac|string -}}
    state: >-
      {% if is_state(sensor,'on') -%}on{% else %}off{% endif %}
  action:
    - alias: 'test if type is defined'
      condition: and
      conditions:
        - condition: template
          value_template: >
            {{ type|lower != 'null' }}
    - alias: 'update binary_sensor.motion_shelly_<type>_<mac>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{ sensor }}
        device_class: >-
          {{ type }}
        friendly_name: >-
          {{- type|capitalize + ' in ' + id|string -}}
        ip: >-
          {{ ip }}
        id: >-
          {{ id }}
        model: >-
          {{ model }}
        mac: >-
          {{ mac }}
        announce: >-
          {{ announce }}
        type: >-
          {{ type }}
        updated: >-
          {{ updated }}
        state: >-
          {{ state }}
    - alias: 'update group.motion_shellies_<type>'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: >-
          {{- 'group.motion_shellies_' + type|string -}}
        friendly_name: >-
          {{ type|capitalize + '(s)' }}
        entity_ids: >-
          [{% for eid in states.binary_sensor|map(attribute='entity_id')|list if ('motion_shelly_' + type|string) in eid  -%}
          {%- if not loop.first -%},{%- endif -%}
          "{{- eid -}}"
          {%- endfor %}]
        updated: >-
          {{ updated }}
        state: >-
          {{ state }}
    - alias: 'update group.motion_shellies'
      service: python_script.set_state
      data_template:
        allow_create: true
        entity_id: group.motion_shellies
        friendly_name: 'All shellies'
        ip: >-
          {{ ip }}
        count: >-
          {{- macs|string|from_json|list|unique|list|count -}}
        macs: >-
          {{ macs|string|from_json|list|unique|list|to_json|string }}
        ids: >-
          {{ ids|string|from_json|list|unique|list|to_json|string }}
        models: >-
          {{ models|string|from_json|list|unique|list|to_json|string }}
        entity_ids: >-
          [{% for eid in states.binary_sensor|map(attribute='entity_id')|list if 'motion_shelly_' in eid  -%}
          {%- if not loop.first -%},{%- endif -%}
          "{{- eid -}}"
          {%- endfor %}]
        updated: >-
          {{ updated }}
        state: >-
          {{ state }}
    - alias: 'update sensor.motion_shellies_settings'
      service: homeassistant.update_entity
      entity_id: sensor.motion_shellies_settings
    - alias: 'update sensor.motion_shellies_update'
      service: homeassistant.update_entity
      entity_id: sensor.motion_shellies_update
