###
# homeassistant/automation/motion/shelly.yaml
###

- id: motion_detector_shelly_announce
  alias: motion_detector_shelly_announce
  initial_state: on
  trigger:
    - platform: state
      entity_id: sensor.motion_detector_shelly_announce
    - platform: time_pattern
      minutes: /15
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >-
          {% set s = states('sensor.motion_detector_shelly_announce')|lower == 'unavailable' %}
          {{ s|lower == 'unavailable' }}
      - condition: template
        value_template: >-
          {{ is_state('binary_sensor.motion_detector_shelly_announce','on') }}
  action:
    - service_template: mqtt.publish
      data_template:
        topic: >-
          {{- 'shellies/command' -}}
        payload_template: >-
          {{- 'announce' -}}
        qos: 2
        retain: false
